{"version":3,"sources":["plugin.ts"],"names":["Plugin","PluginType","utility","undefined","configure","analytics","update","settings","type","execute","event","shutdown","EventPlugin","result","EventType","IdentifyEvent","identify","TrackEvent","track","ScreenEvent","screen","AliasEvent","alias","GroupEvent","group","flush","reset","DestinationPlugin","destination","Timeline","hasSettings","get","key","isEnabled","customerDisabled","integrations","add","plugin","timeline","apply","closure","remove","beforeResult","applyPlugins","before","enrichmentResult","enrichment","afterResult","after","UtilityPlugin","PlatformPlugin"],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/no-unused-vars */\n\nimport type { SegmentClient } from './analytics';\nimport { Timeline } from './timeline';\nimport {\n  AliasEventType,\n  EventType,\n  GroupEventType,\n  IdentifyEventType,\n  PluginType,\n  ScreenEventType,\n  SegmentAPISettings,\n  SegmentEvent,\n  TrackEventType,\n  UpdateType,\n} from './types';\n\nexport class Plugin {\n  // default to utility to avoid automatic processing\n  type: PluginType = PluginType.utility;\n  analytics?: SegmentClient = undefined;\n\n  configure(analytics: SegmentClient) {\n    this.analytics = analytics;\n  }\n\n  // @ts-ignore\n  update(settings: SegmentAPISettings, type: UpdateType) {\n    // do nothing by default, user can override.\n  }\n\n  execute(event: SegmentEvent): SegmentEvent | undefined {\n    // do nothing.\n    return event;\n  }\n\n  shutdown() {\n    // do nothing by default, user can override.\n  }\n}\n\nexport class EventPlugin extends Plugin {\n  execute(event: SegmentEvent): SegmentEvent | undefined {\n    if (event === undefined) {\n      return event;\n    }\n    let result = event;\n    switch (result.type) {\n      case EventType.IdentifyEvent:\n        result = this.identify(result);\n        break;\n      case EventType.TrackEvent:\n        result = this.track(result);\n        break;\n      case EventType.ScreenEvent:\n        result = this.screen(result);\n        break;\n      case EventType.AliasEvent:\n        result = this.alias(result);\n        break;\n      case EventType.GroupEvent:\n        result = this.group(result);\n        break;\n    }\n    return result;\n  }\n\n  // Default implementations that forward the event. This gives plugin\n  // implementors the chance to interject on an event.\n  identify(event: IdentifyEventType) {\n    return event;\n  }\n\n  track(event: TrackEventType) {\n    return event;\n  }\n\n  screen(event: ScreenEventType) {\n    return event;\n  }\n\n  alias(event: AliasEventType) {\n    return event;\n  }\n\n  group(event: GroupEventType) {\n    return event;\n  }\n\n  flush() {}\n\n  reset() {}\n}\n\nexport class DestinationPlugin extends EventPlugin {\n  // default to destination\n  type = PluginType.destination;\n\n  key = '';\n\n  timeline = new Timeline();\n\n  private hasSettings() {\n    return this.analytics?.settings.get()?.[this.key] !== undefined;\n  }\n\n  private isEnabled(event: SegmentEvent): boolean {\n    let customerDisabled = false;\n    if (event.integrations?.[this.key] === false) {\n      customerDisabled = true;\n    }\n\n    return this.hasSettings() && !customerDisabled;\n  }\n\n  /**\n     Adds a new plugin to the currently loaded set.\n\n     - Parameter plugin: The plugin to be added.\n     - Returns: Returns the name of the supplied plugin.\n  */\n  add(plugin: Plugin) {\n    const analytics = this.analytics;\n    if (analytics) {\n      plugin.configure(analytics);\n    }\n    this.timeline.add(plugin);\n    return plugin;\n  }\n\n  /**\n     Applies the supplied closure to the currently loaded set of plugins.\n\n     - Parameter closure: A closure that takes an plugin to be operated on as a parameter.\n  */\n  apply(closure: (plugin: Plugin) => void) {\n    this.timeline.apply(closure);\n  }\n\n  configure(analytics: SegmentClient) {\n    this.analytics = analytics;\n    this.apply((plugin) => {\n      plugin.configure(analytics);\n    });\n  }\n\n  /**\n     Removes and unloads plugins with a matching name from the system.\n\n     - Parameter pluginName: An plugin name.\n  */\n  remove(plugin: Plugin) {\n    this.timeline.remove(plugin);\n  }\n\n  execute(event: SegmentEvent): SegmentEvent | undefined {\n    if (!this.isEnabled(event)) {\n      return undefined;\n    }\n\n    // Apply before and enrichment plugins\n    const beforeResult = this.timeline.applyPlugins({\n      type: PluginType.before,\n      event,\n    });\n\n    if (beforeResult === undefined) {\n      return;\n    }\n\n    const enrichmentResult = this.timeline.applyPlugins({\n      type: PluginType.enrichment,\n      event: beforeResult,\n    });\n\n    // Now send the event to the destination by executing the normal flow of an EventPlugin\n    super.execute(enrichmentResult);\n\n    // apply .after plugins\n    let afterResult = this.timeline.applyPlugins({\n      type: PluginType.after,\n      event: enrichmentResult,\n    });\n\n    return afterResult;\n  }\n}\n\nexport class UtilityPlugin extends EventPlugin {}\n\n// For internal platform-specific bits\nexport class PlatformPlugin extends Plugin {}\n"]}